<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å‹•ç‰©å ã„ | Webã‚¢ãƒ—ãƒª</title>
  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0f1a33;
      --card:#0f1830cc;
      --line:#ffffff1f;
      --text:#eaf0ff;
      --muted:#b9c6ffcc;
      --accent:#7aa7ff;
      --good:#7dffb0;
      --warn:#ffd36a;
      --bad:#ff7a8e;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 10% 10%, #2b5cff2a, transparent 60%),
        radial-gradient(900px 700px at 90% 20%, #ff63c72a, transparent 55%),
        radial-gradient(900px 700px at 40% 100%, #49ffd02a, transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }

    .app{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
    }

    @media (max-width: 860px){
      .app{ grid-template-columns: 1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .header{
      padding:20px 22px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
    }
    .title{
      margin:0;
      font-size:22px;
      letter-spacing:.02em;
    }
    .subtitle{
      margin:4px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }

    .chip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      user-select:none;
      white-space:nowrap;
      background: #0000001a;
    }

    .content{
      padding:18px 22px 22px;
    }

    .grid{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 520px){
      .grid{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#07102580;
      color:var(--text);
      outline:none;
    }
    input::placeholder{ color:#b9c6ff80; }
    input:focus, select:focus{
      border-color:#7aa7ff66;
      box-shadow: 0 0 0 4px #7aa7ff22;
    }

    .actions{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    button{
      border:none;
      cursor:pointer;
      padding:12px 14px;
      border-radius:16px;
      font-weight:700;
      letter-spacing:.02em;
      color:var(--text);
      background: linear-gradient(135deg, #3a7cff, #9a52ff);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      transition: transform .12s ease, filter .12s ease;
      user-select:none;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    button:active{ transform: translateY(0px); filter: brightness(.98); }

    .ghost{
      background: #00000020;
      border:1px solid var(--line);
      box-shadow:none;
      font-weight:600;
    }

    .resultBox{
      padding:18px 20px 20px;
      border-top:1px solid var(--line);
      background: linear-gradient(180deg, #00000000, #00000020);
      min-height: 240px;
      display:grid;
      gap:12px;
      align-content:start;
    }

    .hero{
      display:flex;
      gap:14px;
      align-items:center;
    }

    .emoji{
      width:62px;
      height:62px;
      display:grid;
      place-items:center;
      font-size:34px;
      border-radius:18px;
      border:1px solid var(--line);
      background: #0000001a;
      position:relative;
      overflow:hidden;
    }
    .emoji::after{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at 30% 30%, #ffffff30, transparent 55%);
      transform: rotate(12deg);
    }

    .animalName{
      margin:0;
      font-size:18px;
      line-height:1.2;
    }
    .animalMeta{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }

    .bars{
      display:grid;
      gap:10px;
      margin-top:6px;
    }

    .barRow{
      display:grid;
      grid-template-columns: 90px 1fr 36px;
      gap:10px;
      align-items:center;
      color:var(--muted);
      font-size:12px;
    }
    .bar{
      height:10px;
      border-radius:999px;
      background:#ffffff12;
      border:1px solid var(--line);
      overflow:hidden;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, #7aa7ff, #7dffb0);
      border-radius:999px;
      transition: width .7s cubic-bezier(.2,.9,.2,1);
    }
    .score{
      text-align:right;
      font-variant-numeric: tabular-nums;
      color:var(--text);
      opacity:.9;
    }

    .msg{
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#00000014;
      line-height:1.7;
      font-size:14px;
    }

    .pillRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#00000012;
      color:var(--muted);
    }

    .side{
      display:grid;
      gap:18px;
    }
    .side .content{ padding:18px 18px 20px; }

    .smallTitle{
      margin:0 0 10px;
      font-size:14px;
      color:var(--text);
      opacity:.95;
    }

    .list{
      display:grid;
      gap:10px;
    }

    .hint{
      border:1px dashed #ffffff2a;
      border-radius:18px;
      padding:12px 12px;
      color:var(--muted);
      background:#00000012;
      font-size:12px;
      line-height:1.6;
    }

    .historyItem{
      border:1px solid var(--line);
      background:#00000012;
      border-radius:16px;
      padding:12px 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }

    .historyLeft{
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .historyEmoji{
      width:34px;height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      display:grid;
      place-items:center;
      background:#00000014;
      flex:0 0 auto;
    }
    .historyText{
      min-width:0;
    }
    .historyText b{
      display:block;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .historyText span{
      display:block;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin-top:2px;
    }

    .tinyBtn{
      padding:9px 10px;
      border-radius:14px;
      background:#00000020;
      border:1px solid var(--line);
      box-shadow:none;
      font-weight:700;
      font-size:12px;
      white-space:nowrap;
    }

    .fadeIn{
      animation: fadeIn .35s ease both;
    }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }
  </style>
</head>

<body>
  <main class="app">
    <!-- ãƒ¡ã‚¤ãƒ³ -->
    <section class="card">
      <div class="header">
        <div>
          <h1 class="title">å‹•ç‰©å ã„</h1>
          <p class="subtitle">èª•ç”Ÿæ—¥ã‚„æ°—åˆ†ã‚’å…¥åŠ›ã—ã¦ã€ä»Šæ—¥ã®ã‚ãªãŸã‚’â€œå‹•ç‰©ã‚¿ã‚¤ãƒ—â€ã§å ã„ã¾ã™ã€‚</p>
        </div>
        <div class="chip" id="seedChip">Seed: -</div>
      </div>

      <div class="content">
        <div class="grid">
          <div>
            <label for="nameInput">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆä»»æ„ï¼‰</label>
            <input id="nameInput" placeholder="ä¾‹ï¼‰ãƒˆãƒŸãƒ¼ / ã‚ã‚†ã¿ / you" maxlength="24" />
          </div>
          <div>
            <label for="birthInput">èª•ç”Ÿæ—¥ï¼ˆä»»æ„ï¼‰</label>
            <input id="birthInput" type="date" />
          </div>
          <div>
            <label for="moodSelect">ä»Šã®æ°—åˆ†</label>
            <select id="moodSelect">
              <option value="normal">ãµã¤ã†</option>
              <option value="up">ã‚¢ã‚²</option>
              <option value="down">ãŠã¤ã‹ã‚Œ</option>
              <option value="focus">é›†ä¸­ã—ãŸã„</option>
              <option value="love">æ‹æ„›ãƒ¢ãƒ¼ãƒ‰</option>
              <option value="money">ä»•äº‹/ãŠé‡‘</option>
            </select>
          </div>
          <div>
            <label for="styleSelect">å ã„ã®ãƒ†ã‚¤ã‚¹ãƒˆ</label>
            <select id="styleSelect">
              <option value="soft">ã‚„ã•ã—ã‚</option>
              <option value="sharp">ã‚ºãƒãƒƒã¨</option>
              <option value="funny">ã¡ã‚‡ã„ãƒã‚¿</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button id="drawBtn">å ã†</button>
          <button class="ghost" id="randomBtn" type="button">ãƒ©ãƒ³ãƒ€ãƒ ã§å ã†</button>
          <button class="ghost" id="resetBtn" type="button">å±¥æ­´ã‚¯ãƒªã‚¢</button>
        </div>
      </div>

      <div class="resultBox" id="resultBox">
        <div class="msg" id="welcomeMsg">
          ã€Œå ã†ã€ã‚’æŠ¼ã™ã¨çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚èª•ç”Ÿæ—¥ã‚’å…¥ã‚Œã‚‹ã¨æ¯å›åŒã˜çµæœã«ãªã‚Šã‚„ã™ããªã‚Šã¾ã™ã€‚
        </div>
      </div>
    </section>

    <!-- ã‚µã‚¤ãƒ‰ -->
    <aside class="side">
      <section class="card">
        <div class="header">
          <div>
            <h2 class="title" style="font-size:16px;margin:0;">æœ€è¿‘ã®çµæœ</h2>
            <p class="subtitle" style="margin-top:4px;">ç›´è¿‘5ä»¶ã‚’ä¿å­˜ï¼ˆç«¯æœ«å†…ï¼‰</p>
          </div>
          <div class="chip">localStorage</div>
        </div>
        <div class="content">
          <div class="list" id="historyList"></div>
          <div class="hint" style="margin-top:12px;">
            ã‚«ã‚¹ã‚¿ãƒ ã—ãŸã„å ´åˆï¼š<br>
            JSå†…ã® <b>animals</b> é…åˆ—ã«å‹•ç‰©ã‚¿ã‚¤ãƒ—ã‚„æ–‡ç« ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
          </div>
        </div>
      </section>

      <section class="card">
        <div class="header">
          <div>
            <h2 class="title" style="font-size:16px;margin:0;">ä½¿ã„æ–¹</h2>
            <p class="subtitle" style="margin-top:4px;">è¶…ã‚·ãƒ³ãƒ—ãƒ«è¨­è¨ˆ</p>
          </div>
          <div class="chip">HTML/CSS/JS</div>
        </div>
        <div class="content">
          <div class="pillRow">
            <span class="pill">1ãƒ•ã‚¡ã‚¤ãƒ«</span>
            <span class="pill">å¤–éƒ¨ä¾å­˜ãªã—</span>
            <span class="pill">å±¥æ­´ä¿å­˜</span>
            <span class="pill">èª•ç”Ÿæ—¥ã§å›ºå®š</span>
          </div>
          <div class="hint" style="margin-top:12px;">
            èª•ç”Ÿæ—¥ã‚ã‚Šï¼šåŒã˜å…¥åŠ›ã§åŒã˜çµæœãŒå‡ºã‚„ã™ã„ï¼ˆå†ç¾æ€§ï¼‰<br>
            èª•ç”Ÿæ—¥ãªã—ï¼šæ¯å›ãƒ©ãƒ³ãƒ€ãƒ æ€§ãŒé«˜ã„ï¼ˆéŠã³ï¼‰<br>
          </div>
        </div>
      </section>
    </aside>
  </main>

  <script>
    // =========================
    //  å‹•ç‰©ã‚¿ã‚¤ãƒ—å®šç¾©
    // =========================
    const animals = [
      {
        key: "lion",
        name: "ãƒ©ã‚¤ã‚ªãƒ³",
        emoji: "ğŸ¦",
        tags: ["ç‹é“", "æ±ºæ–­åŠ›", "ãƒªãƒ¼ãƒ€ãƒ¼"],
        base: { love: 62, work: 78, health: 58 },
        soft: {
          title: "å ‚ã€…ã¨é€²ã‚€æ—¥",
          text: "è¿·ã„ãŒæ¸›ã£ã¦ã€æ±ºã‚ãŸã“ã¨ã«è¿½ã„é¢¨ãŒå¹ãã‚„ã™ã„æ—¥ã€‚å°ã•ãã¦ã‚‚â€œæ±ºæ–­â€ã‚’1ã¤å…¥ã‚Œã‚‹ã¨ä¸€æ°—ã«æµã‚ŒãŒæ•´ã„ã¾ã™ã€‚"
        },
        sharp: {
          title: "æ±ºã‚ã‚ã€‚å‹•ã‘ã€‚",
          text: "å„ªæŸ”ä¸æ–­ã¯ã‚³ã‚¹ãƒˆã€‚ä»Šæ—¥ã¯åˆ¤æ–­ã‚’å…ˆã«æ¸ˆã¾ã›ã¦ã€å®Ÿè¡Œã«æ™‚é–“ã‚’å›ã™ã»ã©å‹ã¡ã¾ã™ã€‚"
        },
        funny: {
          title: "ç‹æ§˜ãƒ¢ãƒ¼ãƒ‰",
          text: "ã‚„ã‚‹æ°—ã¯æº€ã‚¿ãƒ³ã€‚ã‚ã¨ã¯â€œå…ˆå»¶ã°ã—å¤§è‡£â€ã‚’æ›´è¿­ã™ã‚‹ã ã‘ã§ã™ã€‚"
        }
      },
      {
        key: "cat",
        name: "ãƒã‚³",
        emoji: "ğŸˆ",
        tags: ["ç›´æ„Ÿ", "è‡ªç”±", "ã“ã ã‚ã‚Š"],
        base: { love: 74, work: 55, health: 66 },
        soft: {
          title: "ç›´æ„ŸãŒå½“ãŸã‚Šã‚„ã™ã„æ—¥",
          text: "ä»Šæ—¥ã¯â€œå¥½ã/å«Œã„â€ã®ã‚»ãƒ³ã‚µãƒ¼ãŒå†´ãˆã¾ã™ã€‚å¿ƒåœ°ã„ã„æ–¹ã‚’é¸ã¶ã»ã©é‹ãŒä¹—ã‚Šã‚„ã™ã„ã§ã™ã€‚"
        },
        sharp: {
          title: "åˆã‚ãªã„ã‚‚ã®ã¯åˆ‡ã‚Œ",
          text: "æ°—ãŒæ•£ã‚‹è¦å› ã‚’1ã¤æ¨ã¦ã‚‹ã ã‘ã§é›†ä¸­ãŒæˆ»ã‚Šã¾ã™ã€‚é æ…®ã¯ä¸è¦ã€‚"
        },
        funny: {
          title: "æ°—ã¾ãã‚Œã¯æ‰èƒ½",
          text: "äºˆå®šå¤‰æ›´ï¼ŸOKã€‚ã‚€ã—ã‚ã‚ãªãŸã®ç›´æ„ŸãŒä¸Šå¸ã§ã™ã€‚"
        }
      },
      {
        key: "dog",
        name: "ã‚¤ãƒŒ",
        emoji: "ğŸ¶",
        tags: ["èª å®Ÿ", "å”åŠ›", "ç¶™ç¶š"],
        base: { love: 68, work: 63, health: 72 },
        soft: {
          title: "å‘³æ–¹ãŒå¢—ãˆã‚‹æ—¥",
          text: "ä¸å¯§ãªä¸€è¨€ãŒä¿¡é ¼ã‚’ç©ã¿ä¸Šã’ã¾ã™ã€‚ç›¸è«‡ãƒ»å…±æœ‰ã‚’å¢—ã‚„ã™ã»ã©å¥½è»¢ã—ã‚„ã™ã„ã§ã™ã€‚"
        },
        sharp: {
          title: "â€œè‰¯ã„äººâ€ã§çµ‚ã‚ã‚‹ãª",
          text: "å”åŠ›ã¯æ­¦å™¨ã€‚ä»Šæ—¥ã¯ã€ä½•ã‚’é”æˆã™ã‚‹ã‹ã€ã‚’è¨€èªåŒ–ã—ã¦å‹•ã‘ã°æˆæœãŒå‡ºã¾ã™ã€‚"
        },
        funny: {
          title: "å¿ èª å¿ƒã€ç™ºå‹•",
          text: "è¤’ã‚ã‚‰ã‚ŒãŸã‚‰ä¼¸ã³ã‚‹æ—¥ã€‚è‡ªåˆ†ã‚‚è‡ªåˆ†ã‚’è¤’ã‚ã¦ã‹ã‚‰èµ°ã‚Šã¾ã—ã‚‡ã†ã€‚"
        }
      },
      {
        key: "fox",
        name: "ã‚­ãƒ„ãƒ",
        emoji: "ğŸ¦Š",
        tags: ["åˆ†æ", "æˆ¦ç•¥", "ã‚¹ãƒãƒ¼ãƒˆ"],
        base: { love: 56, work: 76, health: 60 },
        soft: {
          title: "é ­ãŒã‚¯ãƒªã‚¢ãªæ—¥",
          text: "æƒ…å ±ã‚’æ•´ç†ã—ã¦å„ªå…ˆé †ä½ã‚’æ±ºã‚ã‚‹ã¨ã€æ™‚é–“ãŒå¢—ãˆãŸã‚ˆã†ã«æ„Ÿã˜ã¾ã™ã€‚ã¾ãšã¯â€œæ¨ã¦ã‚‹â€ã‹ã‚‰ã€‚"
        },
        sharp: {
          title: "ã‚„ã‚‰ãªã„ã“ã¨ã‚’æ±ºã‚ã‚",
          text: "å¿™ã—ã•ã¯èƒ½åŠ›ã˜ã‚ƒãªã„ã€‚ã‚„ã‚ã‚‹é …ç›®ã‚’å…ˆã«åˆ‡ã‚Œã°å‹ã¡ç­‹ãŒè¦‹ãˆã¾ã™ã€‚"
        },
        funny: {
          title: "ç­–å£«ã€ãƒ‹ãƒ¤ãƒª",
          text: "å‘¨ã‚ŠãŒãƒã‚¿ã¤ãã»ã©ã‚ãªãŸã¯å†·é™ã€‚ãƒ¡ã‚¬ãƒã‚’ã‚¯ã‚¤ãƒƒï¼ˆã—ã¦ãªã„ï¼‰"
        }
      },
      {
        key: "penguin",
        name: "ãƒšãƒ³ã‚®ãƒ³",
        emoji: "ğŸ§",
        tags: ["å …å®Ÿ", "æ®µå–ã‚Š", "å®‰å®š"],
        base: { love: 60, work: 66, health: 74 },
        soft: {
          title: "æ•´ãˆã‚‹ã¨é‹ãŒä¸ŠãŒã‚‹æ—¥",
          text: "ç’°å¢ƒã‚’æ•´ãˆã‚‹ã»ã©é›†ä¸­ãŒæˆ»ã‚Šã¾ã™ã€‚æœºã®ä¸Šã€é€šçŸ¥ã€ã‚¿ãƒ–â€¦â€œä¸€ã¤ã ã‘ç‰‡ä»˜ã‘ã‚‹â€ã§OKã€‚"
        },
        sharp: {
          title: "æ®µå–ã‚ŠãŒ9å‰²",
          text: "å§‹ã‚ã‚‹å‰ã«5åˆ†ã®æº–å‚™ã€‚ãã“ã‚’çœãã¨30åˆ†å¤±ã„ã¾ã™ã€‚"
        },
        funny: {
          title: "è¡Œé€²ã€é–‹å§‹",
          text: "ã‚ãªãŸãŒæ•´ãˆã‚‹ã¨å…¨å“¡ãŒæ¥½ã«ãªã‚‹ã€‚ä»Šæ—¥ã®ã‚ãªãŸã¯â€œéšŠé•·ãƒšãƒ³ã‚®ãƒ³â€ã§ã™ã€‚"
        }
      },
      {
        key: "owl",
        name: "ãƒ•ã‚¯ãƒ­ã‚¦",
        emoji: "ğŸ¦‰",
        tags: ["æ´å¯Ÿ", "å­¦ç¿’", "é™ã‘ã•"],
        base: { love: 58, work: 70, health: 64 },
        soft: {
          title: "æ·±ãè€ƒãˆã‚‹ã»ã©è‰¯ã„æ—¥",
          text: "æµ…ã„ãƒã‚¤ã‚ºã‚ˆã‚Šã€æ·±ã„å•ã„ãŒä¾¡å€¤ã«ãªã‚Šã¾ã™ã€‚èª­ã‚€ãƒ»æ›¸ããƒ»æ•´ç†ã™ã‚‹ãŒå‰ã€‚"
        },
        sharp: {
          title: "ç†è§£ã¯æ­¦å™¨",
          text: "ä»Šæ—¥ã®å‹ã¡ç­‹ã¯â€œè§£åƒåº¦â€ã€‚æ›–æ˜§ãªéƒ¨åˆ†ã‚’ä¸€ã¤æ½°ã›ã°ä¸€æ°—ã«å‰é€²ã—ã¾ã™ã€‚"
        },
        funny: {
          title: "å¤œã®è³¢è€…",
          text: "é™ã‹ãªå ´æ‰€ã«è¡Œãã¨èƒ½åŠ›ãŒ1.3å€ã€‚ãƒ•ã‚¯ãƒ­ã‚¦è£œæ­£ã§ã™ã€‚"
        }
      }
    ];

    // =========================
    //  ä¹±æ•°ï¼ˆå†ç¾æ€§ï¼‰: xmur3 + mulberry32
    // =========================
    function xmur3(str){
      let h = 1779033703 ^ str.length;
      for(let i=0;i<str.length;i++){
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = (h << 13) | (h >>> 19);
      }
      return function(){
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        return (h ^= (h >>> 16)) >>> 0;
      }
    }
    function mulberry32(a){
      return function(){
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      }
    }

    // =========================
    //  ã‚¹ã‚³ã‚¢ç”Ÿæˆï¼ˆæ°—åˆ†ã§è£œæ­£ï¼‰
    // =========================
    function applyMood(base, mood){
      const b = { ...base };
      const clamp = (n)=> Math.max(0, Math.min(100, n));

      const delta = {
        normal: { love: 0,  work: 0,  health: 0 },
        up:     { love: +6, work: +6, health: +2 },
        down:   { love: -2, work: -6, health: -6 },
        focus:  { love: -2, work: +10, health: -2 },
        love:   { love: +12, work: -4, health: 0 },
        money:  { love: -4, work: +12, health: -2 },
      }[mood] || { love:0, work:0, health:0 };

      b.love = clamp(b.love + delta.love);
      b.work = clamp(b.work + delta.work);
      b.health = clamp(b.health + delta.health);
      return b;
    }

    // =========================
    //  æ–‡è¨€é¸æŠ
    // =========================
    function pickStyleText(animal, style){
      if(style === "sharp") return animal.sharp;
      if(style === "funny") return animal.funny;
      return animal.soft;
    }

    // =========================
    //  å±¥æ­´
    // =========================
    const HISTORY_KEY = "animal_fortune_history_v1";
    function loadHistory(){
      try{
        return JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
      }catch(e){
        return [];
      }
    }
    function saveHistory(list){
      localStorage.setItem(HISTORY_KEY, JSON.stringify(list.slice(0,5)));
    }

    // =========================
    //  UIå‚ç…§
    // =========================
    const el = (id)=>document.getElementById(id);
    const nameInput = el("nameInput");
    const birthInput = el("birthInput");
    const moodSelect = el("moodSelect");
    const styleSelect = el("styleSelect");
    const seedChip = el("seedChip");
    const resultBox = el("resultBox");
    const historyList = el("historyList");

    el("drawBtn").addEventListener("click", ()=> runFortune(false));
    el("randomBtn").addEventListener("click", ()=> runFortune(true));
    el("resetBtn").addEventListener("click", ()=>{
      localStorage.removeItem(HISTORY_KEY);
      renderHistory();
      resultBox.innerHTML = '<div class="msg fadeIn">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã€Œå ã†ã€ã‚’ã©ã†ãã€‚</div>';
    });

    // Enterã§å ã†
    [nameInput, birthInput].forEach(x=>{
      x.addEventListener("keydown", (e)=>{
        if(e.key === "Enter") runFortune(false);
      });
    });

    // =========================
    //  ãƒ¡ã‚¤ãƒ³å‡¦ç†
    // =========================
    function runFortune(forceRandom){
      const name = (nameInput.value || "").trim();
      const birth = birthInput.value; // "YYYY-MM-DD" or ""
      const mood = moodSelect.value;
      const style = styleSelect.value;

      // seedï¼ˆèª•ç”Ÿæ—¥ãŒã‚ã‚Œã°å†ç¾æ€§ã€ãªã‘ã‚Œã°æ—¥æ™‚ã§ãƒ©ãƒ³ãƒ€ãƒ æ€§ï¼‰
      const today = new Date();
      const ymd = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;
      const fallback = `${ymd}-${today.getHours()}-${today.getMinutes()}-${today.getSeconds()}-${Math.random()}`;

      const seedStr = forceRandom
        ? `RANDOM-${fallback}`
        : `NAME:${name}|BIRTH:${birth || "none"}|MOOD:${mood}|STYLE:${style}|DATE:${ymd}`;

      const seedFn = xmur3(seedStr);
      const rng = mulberry32(seedFn());

      seedChip.textContent = "Seed: " + seedStr.slice(0, 26) + (seedStr.length>26 ? "â€¦" : "");

      // å‹•ç‰©æ±ºå®š
      const idx = Math.floor(rng() * animals.length);
      const animal = animals[idx];

      // ã‚¹ã‚³ã‚¢ï¼ˆè»½ã„æºã‚‰ãï¼‰
      const base = applyMood(animal.base, mood);
      const jitter = () => Math.floor((rng() * 9) - 4); // -4..+4
      const scores = {
        love: Math.max(0, Math.min(100, base.love + jitter())),
        work: Math.max(0, Math.min(100, base.work + jitter())),
        health: Math.max(0, Math.min(100, base.health + jitter())),
      };

      // æ–‡è¨€
      const copy = pickStyleText(animal, style);

      // ãŠã™ã™ã‚è¡Œå‹•ï¼ˆç°¡æ˜“ï¼‰
      const tip = buildTip(animal.key, mood);

      // æç”»
      renderResult({ name, birth, mood, style, seedStr, animal, scores, copy, tip });

      // å±¥æ­´ä¿å­˜
      const hist = loadHistory();
      const when = new Date().toLocaleString("ja-JP", { hour12:false });
      hist.unshift({
        when,
        who: name || "ã‚ãªãŸ",
        animalKey: animal.key,
        animalName: animal.name,
        emoji: animal.emoji,
        title: copy.title
      });
      saveHistory(hist);
      renderHistory();
    }

    function buildTip(animalKey, mood){
      const tips = {
        lion: {
          normal: "5åˆ†ã§â€œä»Šæ—¥ã®æ±ºæ–­â€ã‚’1ã¤æ±ºã‚ã‚‹",
          up: "å‹¢ã„ã®ã¾ã¾â€œ1ã¤ã ã‘å‰å€’ã—â€ã™ã‚‹",
          down: "å°ã•ã„æ±ºæ–­ã ã‘æ¸ˆã¾ã›ã¦ã€ä¼‘ã‚€",
          focus: "ç· åˆ‡ã‚’çŸ­ãåŒºåˆ‡ã£ã¦ã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹",
          love: "ä¸»å°æ¨©ã¯å„ªã—ã•ã§æ¡ã‚‹",
          money: "äº¤æ¸‰ã‚„ä¾¡æ ¼è¦‹ç›´ã—ã«ãƒ„ã‚­"
        },
        cat: {
          normal: "æ°—æŒã¡ã„ã„æ–¹ã‚’1ã¤é¸ã¶",
          up: "ç›´æ„Ÿã§â€œå…ˆã«é¢ç™½ã„æ–¹â€ã¸",
          down: "æƒ…å ±é®æ–­ã—ã¦å›å¾©å„ªå…ˆ",
          focus: "å¥½ããªBGM/ç’°å¢ƒã‚’æ•´ãˆã‚‹",
          love: "é§†ã‘å¼•ãã‚ˆã‚Šâ€œç´ ç›´â€ãŒå‹ã¤",
          money: "ä¸è¦ãªã‚µãƒ–ã‚¹ã‚¯æ•´ç†ãŒå‰"
        },
        dog: {
          normal: "èª°ã‹ã«ä¸€è¨€ã€æ„Ÿè¬ã‚’ä¼ãˆã‚‹",
          up: "ãƒãƒ¼ãƒ é€£æºã§æˆæœã‚’å–ã‚Šã«è¡Œã",
          down: "é ¼ã‚‹/ç›¸è«‡ã™ã‚‹ã‚’1å›å…¥ã‚Œã‚‹",
          focus: "ã‚¿ã‚¹ã‚¯ã‚’å…±æœ‰ã—ã¦ç· åˆ‡ã‚’ä½œã‚‹",
          love: "ç›¸æ‰‹ã®ãƒšãƒ¼ã‚¹ã«åˆã‚ã›ã™ããªã„",
          money: "ä¿¡é ¼ãŒãƒªã‚¿ãƒ¼ãƒ³ã«ç¹‹ãŒã‚‹æ—¥"
        },
        fox: {
          normal: "ã‚„ã‚‰ãªã„ã“ã¨ã‚’1ã¤æ±ºã‚ã‚‹",
          up: "å„ªå…ˆé †ä½TOP1ã«é›†ä¸­æŠ•ä¸‹",
          down: "TODOã‚’3ã¤ã«çµã£ã¦çµ‚ã‚ã‚Š",
          focus: "5åˆ†ã ã‘è¨­è¨ˆã—ã¦ã‹ã‚‰ç€æ‰‹",
          love: "è¨€èªåŒ–ã™ã‚‹ã¨èª¤è§£ãŒæ¸›ã‚‹",
          money: "æ•°å­—ã§åˆ¤æ–­ã™ã‚‹ã¨å‹ã¡ã‚„ã™ã„"
        },
        penguin: {
          normal: "æœºä¸Š/é€šçŸ¥/ã‚¿ãƒ–ã®ã©ã‚Œã‹1ã¤æ•´ç†",
          up: "æ®µå–ã‚Šã‚’å›ºã‚ã¦é€Ÿåº¦ã‚’ä¸Šã’ã‚‹",
          down: "ç’°å¢ƒæ•´å‚™â†’çŸ­æ™‚é–“ä½œæ¥­ã§OK",
          focus: "15åˆ†å˜ä½ã§åŒºåˆ‡ã‚‹ã¨å¼·ã„",
          love: "å®‰å¿ƒæ„ŸãŒæœ€å¤§ã®é­…åŠ›ã«ãªã‚‹",
          money: "å®¶è¨ˆãƒ»åŸä¾¡ãƒ»å›ºå®šè²»ã®è¦‹ç›´ã—"
        },
        owl: {
          normal: "å­¦ã¶/æ›¸ã/æŒ¯ã‚Šè¿”ã‚‹ãŒå‰",
          up: "æ·±æ˜ã‚Šãƒ†ãƒ¼ãƒã‚’1ã¤æ±ºã‚ã‚‹",
          down: "é™ã‹ãªæ™‚é–“ã‚’ç¢ºä¿ã—ã¦å›å¾©",
          focus: "æ›–æ˜§ãªç‚¹ã‚’â€œ1ã¤ã ã‘â€æ½°ã™",
          love: "ç†è§£ã—ã‚ˆã†ã¨ã™ã‚‹å§¿å‹¢ãŒåˆºã•ã‚‹",
          money: "çŸ¥è­˜æŠ•è³‡ãƒ»å­¦ç¿’ãŒå›åã«ç¹‹ãŒã‚‹"
        }
      };
      return (tips[animalKey] && tips[animalKey][mood]) || "æ·±å‘¼å¸ã—ã¦ã€æ¬¡ã®ä¸€æ‰‹ã‚’å°ã•ãå§‹ã‚ã‚‹";
    }

    function moodLabel(v){
      return {
        normal:"ãµã¤ã†",
        up:"ã‚¢ã‚²",
        down:"ãŠã¤ã‹ã‚Œ",
        focus:"é›†ä¸­ã—ãŸã„",
        love:"æ‹æ„›ãƒ¢ãƒ¼ãƒ‰",
        money:"ä»•äº‹/ãŠé‡‘"
      }[v] || v;
    }
    function styleLabel(v){
      return { soft:"ã‚„ã•ã—ã‚", sharp:"ã‚ºãƒãƒƒã¨", funny:"ã¡ã‚‡ã„ãƒã‚¿" }[v] || v;
    }

    function renderResult({ name, birth, mood, style, animal, scores, copy, tip }){
      const who = name || "ã‚ãªãŸ";
      const birthText = birth ? `èª•ç”Ÿæ—¥: ${birth}` : "èª•ç”Ÿæ—¥: æœªå…¥åŠ›";
      const meta = `${who} / ${birthText} / æ°—åˆ†: ${moodLabel(mood)} / ãƒ†ã‚¤ã‚¹ãƒˆ: ${styleLabel(style)}`;

      resultBox.innerHTML = `
        <div class="hero fadeIn">
          <div class="emoji" aria-hidden="true">${animal.emoji}</div>
          <div>
            <h3 class="animalName">${animal.name}ã‚¿ã‚¤ãƒ—ï¼š${copy.title}</h3>
            <p class="animalMeta">${escapeHtml(meta)}</p>
          </div>
        </div>

        <div class="pillRow fadeIn">
          ${animal.tags.map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join("")}
        </div>

        <div class="bars fadeIn">
          ${barRow("æ‹æ„›é‹", scores.love)}
          ${barRow("ä»•äº‹é‹", scores.work)}
          ${barRow("å¥åº·é‹", scores.health)}
        </div>

        <div class="msg fadeIn">
          ${escapeHtml(copy.text)}
        </div>

        <div class="msg fadeIn" style="border-color:#7aa7ff3a;">
          <b>ä»Šæ—¥ã®ãŠã™ã™ã‚è¡Œå‹•ï¼š</b><br>${escapeHtml(tip)}
        </div>
      `;

      // ãƒãƒ¼ã‚’ã‚¢ãƒ‹ãƒ¡ã•ã›ã‚‹
      requestAnimationFrame(()=>{
        resultBox.querySelectorAll(".bar > i").forEach((i)=>{
          const w = i.getAttribute("data-w");
          i.style.width = w + "%";
        });
      });
    }

    function barRow(label, val){
      const v = Math.round(val);
      return `
        <div class="barRow">
          <div>${label}</div>
          <div class="bar"><i data-w="${v}"></i></div>
          <div class="score">${v}</div>
        </div>
      `;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderHistory(){
      const hist = loadHistory();
      if(hist.length === 0){
        historyList.innerHTML = `<div class="hint">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        return;
      }

      historyList.innerHTML = hist.map((h, idx)=>`
        <div class="historyItem fadeIn">
          <div class="historyLeft">
            <div class="historyEmoji">${h.emoji}</div>
            <div class="historyText">
              <b>${escapeHtml(h.who)}ï¼š${escapeHtml(h.animalName)}</b>
              <span>${escapeHtml(h.title)} ãƒ» ${escapeHtml(h.when)}</span>
            </div>
          </div>
          <button class="tinyBtn" data-idx="${idx}" type="button">è¡¨ç¤º</button>
        </div>
      `).join("");

      historyList.querySelectorAll("button[data-idx]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const idx = Number(btn.getAttribute("data-idx"));
          const item = loadHistory()[idx];
          if(!item) return;

          const animal = animals.find(a=>a.key === item.animalKey);
          if(!animal) return;

          // å±¥æ­´ã¯ã‚¹ã‚³ã‚¢ã‚„æ°—åˆ†ç­‰ã‚’ä¿å­˜ã—ã¦ãªã„ã®ã§ã€ç°¡æ˜“è¡¨ç¤ºï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ï¼‰
          resultBox.innerHTML = `
            <div class="hero fadeIn">
              <div class="emoji" aria-hidden="true">${animal.emoji}</div>
              <div>
                <h3 class="animalName">${animal.name}ã‚¿ã‚¤ãƒ—ï¼š${escapeHtml(item.title)}</h3>
                <p class="animalMeta">${escapeHtml(item.when)} / ${escapeHtml(item.who)}</p>
              </div>
            </div>
            <div class="msg fadeIn">
              å±¥æ­´è¡¨ç¤ºã¯ç°¡æ˜“ç‰ˆã§ã™ã€‚å®Œå…¨ã«åŒã˜çµæœã‚’å†ç¾ã—ãŸã„å ´åˆã¯ã€åŒã˜å…¥åŠ›ã§ã€Œå ã†ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
            </div>
          `;
        });
      });
    }

    // åˆæœŸè¡¨ç¤º
    renderHistory();
  </script>
</body>
</html>
